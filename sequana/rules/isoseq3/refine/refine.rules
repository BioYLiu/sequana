rule refine:
    """
    Your data now contains full-length reads, but still needs to be refined by:

    Trimming of poly(A) tails
    Rapid concatmer identification and removal

    Required input:
        __refine__input: subreads bam file

    Required output:
        __refine_output: output CCS bam file

    params:
        config['refine']['options']: any options recognized by CCS

    """
    input:
        count_lima = __refine__input,
        primers= __refine__primers
    output:
        __refine__output
    params:
        kwargs = config['ccs']['options'],
        primers = config['lima']['primers'],
        bam = __refine__bam
    threads:
        config['ccs']['threads']
    log:
        out = __refine__log_std,
        err = __refine__log_err
    run:

        with open (input.count, 'r') as fp:
            next(fp)
            for line in fp:
                row = line.split("\t")
                if row[2].split("_")[0] in row[3].split("_")[0]:
                    primerpair = row[2] + "--" + row[3]
                    break


        bam_file = splitext(params.bam)[0]+primerpair+splitext(params.bam)[1]
        shell("isoseq3 refine %s {params.primers} {output} {params.kwargs} > {log.out} 2> {log.err}" % bam_file)
